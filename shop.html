<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RetroGa Shop</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Doto:wght@100..900&family=Nabla&family=Press+Start+2P&family=Tourney:ital,wght@0,100..900;1,100..900&family=Jersey+10&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <shop-container>
      <shop-header>
        <h1 translate="shopHeader">RetroGa Shop</h1>
        <p translate="shopSubheader">
          Unlock new looks for your ship and the enemy fleet!
        </p>
      </shop-header>

      <section class="skins-grid" id="skins-grid"></section>

      <shop-coins class="shop-coins" aria-live="polite">
        <div class="shop-coin-icon">
          <span class="shop-coin-symbol">¢</span>
        </div>
        <div>
          <div id="coin-count">0</div>
        </div>
      </shop-coins>

      <button id="back-homepage">Back to Home</button>
    </shop-container>

    <script type="module">
      import { injectSettings } from './js/ui/settingsComponent.js';
      import { persistentAudio } from './js/core/persistentAudio.js';

      injectSettings();

      // FIXED: Use persistentAudio navigation
      document.getElementById('back-homepage').addEventListener('click', e => {
        e.preventDefault();
        persistentAudio.navigateTo('homepage.html');
      });

      // Initialize shop immediately
      function initShop() {
        const grid = document.getElementById('skins-grid');
        if (!grid) {
          setTimeout(initShop, 50);
          return;
        }

        grid.innerHTML = '';

        // Map skin IDs to coin prices
        const skinPrices = {
          squarePack: 15,
          starPack: 25,
          prof: 50,
        };

        function addSkin(skinId, name, desc) {
          const price = skinPrices[skinId] || 0;
          const card = document.createElement('article');
          card.className = 'skin-card';
          card.innerHTML = `
        <h3>${name}</h3>
        <p>${desc}</p>
        <button class="purchase-btn" data-skin="${skinId}" data-price="${price}">Buy (¢${price})</button>
        <div class="shop-msg" aria-live="polite"></div>
      `;
          grid.appendChild(card);

          const btn = card.querySelector('button.purchase-btn');
          const msg = card.querySelector('.shop-msg');
          const ownedKey = `${skinId}Owned`;

          function markOwned() {
            localStorage.setItem(ownedKey, 'true');
            btn.textContent = 'Owned';
            btn.disabled = true;
            if (msg) msg.textContent = '';
          }

          // Initial ownership check
          if (localStorage.getItem(ownedKey) === 'true') {
            markOwned();
            return;
          }

          btn.addEventListener('click', () => {
            const coinCount = Number(localStorage.getItem('coinCount') || 0);
            if (coinCount >= price) {
              // Deduct coins and set ownership
              const newCoins = coinCount - price;
              localStorage.setItem('coinCount', String(newCoins));
              markOwned();
            } else {
              if (msg) msg.textContent = `Not enough coins (need ¢${price}).`;
              // Small accessibility hint
              btn.setAttribute('aria-disabled', 'true');
              setTimeout(() => btn.removeAttribute('aria-disabled'), 1200);
            }
          });
        }

        addSkin(
          'squarePack',
          'Square Pack',
          'Blocky vibes for ships and foes.'
        );
        addSkin('starPack', 'Star Pack', 'Stellar shapes for ships and foes.');
        addSkin('prof', 'Prof Pack', 'The Professor invades your fleet!');

        // end initShop
      }

      initShop();

      // Coin counter
      function updateCoinDisplay() {
        const el = document.getElementById('coin-count');
        if (el) el.textContent = Number(localStorage.getItem('coinCount') || 0);
      }

      // Refresh button states based on current coins and ownership
      function refreshShopButtons() {
        const coinCount = Number(localStorage.getItem('coinCount') || 0);
        document.querySelectorAll('.purchase-btn').forEach(btn => {
          const skinId = btn.dataset.skin;
          const price = Number(btn.dataset.price || 0);
          const ownedKey = `${skinId}Owned`;
          if (localStorage.getItem(ownedKey) === 'true') {
            btn.textContent = 'Owned';
            btn.disabled = true;
          } else {
            btn.textContent = `Buy (¢${price})`;
            btn.disabled = coinCount < price;
          }
        });
      }

      // Update UI when coins change
      function updateCoinDisplayAndButtons() {
        updateCoinDisplay();
        refreshShopButtons();
      }

      window.addEventListener(
        'storage',
        e => e.key === 'coinCount' && updateCoinDisplayAndButtons()
      );
      updateCoinDisplayAndButtons();
    </script>
  </body>
</html>
