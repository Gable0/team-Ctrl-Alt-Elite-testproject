<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: core/gameLoop.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: core/gameLoop.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * js/core/gameLoop.js
 * Main game loop and orchestration hub. Initializes all systems,
 * runs the update/draw cycle, and coordinates game state.
 */

import {
  initEnemyModule,
  spawnEnemyWave,
  updateEnemies,
  drawEnemies,
} from '../entities/enemyManager.js';
import { createPlayer, updatePlayer, drawPlayer } from '../entities/player.js';
import { initInput } from './input.js';
import {
  initShooting,
  updatePlayerShots,
  updateEnemyShots,
  drawPlayerShots,
  drawEnemyShots,
  createPlayerShot,
} from '../systems/shootingSystem.js';
import {
  checkPlayerShotCollisions,
  checkEnemyShotCollisions,
} from '../systems/collision/shotCollisions.js';
import { checkPlayerEnemyCollision } from '../systems/collision/entityCollisions.js';
import {
  initEnemyAttack,
  scheduleEnemyAttacks,
  updateAttackingEnemy,
} from '../systems/enemyAttack.js';
import {
  createInitialGame,
  handleEnemyKilled,
  handlePlayerHit,
  handleLevelProgression,
  updateInvincibility,
  updateLevelTransition,
} from '../state/gameState.js';
import { drawHUD, drawLevelTransition } from '../ui/hud.js';
import { initPauseMenu } from '../ui/pauseMenu.js';
import {
  spawnPowerUp,
  updatePowerUps,
  drawPowerUps,
} from '../systems/powerUps.js';
import { spawnCoin, updateCoins, drawCoins } from '../systems/coins.js';
import {
  initBackground,
  updateBackground,
  drawBackground,
} from './background.js';
import { initAudio } from '../systems/audioManager.js';
import { persistentAudio } from './persistentAudio.js';
import { loadEnemySkinImage } from '../skins/skinAssets.js';

// ... inside your async game init / start function
// Preload all custom enemy skins
await loadEnemySkinImage('prof', 'assets/images/prof.jpg'); // Prof skin
// await loadEnemySkinImage('futureSkin', 'assets/images/future.jpg'); // add more later

//Stop intro audio when  game starts
persistentAudio.stop();
/** @type {HTMLCanvasElement} */
const canvas = document.getElementById('game');

/** @type {CanvasRenderingContext2D} */
const ctx = canvas.getContext('2d');

/** Y-position that acts as a movement barrier for the player (75% of canvas height) */
const barrierY = canvas.height * 0.75;

// ---------------------------------------------------------------------
// System initialization
// ---------------------------------------------------------------------
initInput();
initEnemyModule(canvas, ctx);
initEnemyAttack(canvas);
initShooting(canvas);
initBackground(canvas);
initAudio(); // Initialize audio system

/** Global game state object created from gameState.js */
const Game = createInitialGame();
Game.player = createPlayer(canvas);

initPauseMenu(Game);

/**
 * Updates all game logic each frame.
 *
 * @param {number} delta - Time elapsed since the last frame in seconds.
 */
function update(delta) {
  if (Game.gameOver || Game.paused) return;

  updateInvincibility(Game, delta);

  // Level transition screen blocks normal gameplay updates
  if (updateLevelTransition(Game, delta)) {
    return;
  }

  updateBackground(delta, canvas);
  updateEnemies(Game, delta);
  updatePlayer(Game, delta, canvas, barrierY, createPlayerShot);
  updatePlayerShots(Game, delta);
  updateEnemyShots(Game, delta);
  updatePowerUps(Game, delta, canvas);
  updateCoins(Game, delta, canvas);

  // Enemy dive attacks only start after the player can shoot
  if (Game.playerShootingUnlocked) {
    Game.attackTimer = scheduleEnemyAttacks(
      Game.enemies,
      Game.player,
      delta,
      Game.attackTimer
    );
  }

  // Update any enemies currently performing a dive attack
  for (const enemy of Game.enemies) {
    if (enemy.state === 'attacking') {
      updateAttackingEnemy(enemy, delta);
    }
  }

  // Player bullet → enemy collision
  checkPlayerShotCollisions(Game, enemy => {
    handleEnemyKilled(Game, enemy);
    spawnPowerUp(Game, enemy);
    spawnCoin(Game, enemy);
  });

  // Player can only be hit when not invincible
  if (Game.invincibilityTimer &lt;= 0) {
    // Check enemy laser hits (pass hit type to handlePlayerHit)
    checkEnemyShotCollisions(Game, hitType => handlePlayerHit(Game, hitType));

    // Check enemy collision (pass hit type to handlePlayerHit)
    checkPlayerEnemyCollision(Game, hitType => handlePlayerHit(Game, hitType));
  }

  // Handles wave completion → next level progression
  handleLevelProgression(Game, delta, spawnEnemyWave);
}

/**
 * Renders a single frame to the canvas.
 */
function draw() {
  drawBackground(ctx, canvas);

  if (Game.showingLevelTransition) {
    drawPlayer(ctx, Game.player, Game.invincibilityTimer, Game);
    drawLevelTransition(ctx, canvas, Game);
  } else {
    drawEnemies(Game.enemies, Game);
    drawEnemyShots(ctx, Game.enemyShots);
    drawPlayerShots(ctx, Game.playerShots);
    drawPowerUps(ctx, Game.powerUps);
    drawCoins(ctx, Game.coins);
    drawPlayer(ctx, Game.player, Game.invincibilityTimer, Game);
  }

  drawHUD(ctx, canvas, Game);
}

/**
 * Main animation loop using requestAnimationFrame.
 *
 * @param {DOMHighResTimeStamp} timestamp - Performance timestamp provided by rAF.
 */
function loop(timestamp) {
  const delta = (timestamp - Game.lastTime) / 1000 || 0;
  Game.lastTime = timestamp;

  update(delta);
  draw();

  requestAnimationFrame(loop);
}

/**
 * Starts the game loop.
 */
function start() {
  Game.lastTime = performance.now();
  requestAnimationFrame(loop);
}

// Begin the game
spawnEnemyWave(Game);
start();

// Expose Game object globally for debugging
window.Game = Game;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="PersistentAudioManager.html">PersistentAudioManager</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Game">Game</a></li><li><a href="global.html#advanceEnemyAlongPath">advanceEnemyAlongPath</a></li><li><a href="global.html#audioManager">audioManager</a></li><li><a href="global.html#barrierY">barrierY</a></li><li><a href="global.html#boxesOverlap">boxesOverlap</a></li><li><a href="global.html#canvas">canvas</a></li><li><a href="global.html#canvasRef">canvasRef</a></li><li><a href="global.html#checkEnemyShotCollisions">checkEnemyShotCollisions</a></li><li><a href="global.html#checkPlayerEnemyCollision">checkPlayerEnemyCollision</a></li><li><a href="global.html#checkPlayerShotCollisions">checkPlayerShotCollisions</a></li><li><a href="global.html#createEnemy">createEnemy</a></li><li><a href="global.html#createInitialGame">createInitialGame</a></li><li><a href="global.html#createPlayer">createPlayer</a></li><li><a href="global.html#createPlayerShot">createPlayerShot</a></li><li><a href="global.html#ctx">ctx</a></li><li><a href="global.html#ctxRef">ctxRef</a></li><li><a href="global.html#draw">draw</a></li><li><a href="global.html#drawBackground">drawBackground</a></li><li><a href="global.html#drawEnemies">drawEnemies</a></li><li><a href="global.html#drawEnemyShots">drawEnemyShots</a></li><li><a href="global.html#drawPlayer">drawPlayer</a></li><li><a href="global.html#drawPlayerShots">drawPlayerShots</a></li><li><a href="global.html#enemyTypes">enemyTypes</a></li><li><a href="global.html#equipSkin">equipSkin</a></li><li><a href="global.html#fireEnemyShot">fireEnemyShot</a></li><li><a href="global.html#formationConfig">formationConfig</a></li><li><a href="global.html#generateAttackPath">generateAttackPath</a></li><li><a href="global.html#generateEntryPath">generateEntryPath</a></li><li><a href="global.html#getActiveSkin">getActiveSkin</a></li><li><a href="global.html#getEnemyHitbox">getEnemyHitbox</a></li><li><a href="global.html#getEnemyShotHitbox">getEnemyShotHitbox</a></li><li><a href="global.html#getEnemySkinImage">getEnemySkinImage</a></li><li><a href="global.html#getOwnedSkins">getOwnedSkins</a></li><li><a href="global.html#getPlayerHitbox">getPlayerHitbox</a></li><li><a href="global.html#getShotHitbox">getShotHitbox</a></li><li><a href="global.html#handleEnemyKilled">handleEnemyKilled</a></li><li><a href="global.html#handleLevelProgression">handleLevelProgression</a></li><li><a href="global.html#handlePlayerHit">handlePlayerHit</a></li><li><a href="global.html#initAudio">initAudio</a></li><li><a href="global.html#initBackground">initBackground</a></li><li><a href="global.html#initEnemyAttack">initEnemyAttack</a></li><li><a href="global.html#initEnemyModule">initEnemyModule</a></li><li><a href="global.html#initInput">initInput</a></li><li><a href="global.html#initPauseMenu">initPauseMenu</a></li><li><a href="global.html#initSharedAudio">initSharedAudio</a></li><li><a href="global.html#initShooting">initShooting</a></li><li><a href="global.html#initialized">initialized</a></li><li><a href="global.html#isGamePaused">isGamePaused</a></li><li><a href="global.html#isKeyPressed">isKeyPressed</a></li><li><a href="global.html#isSkinOwned">isSkinOwned</a></li><li><a href="global.html#killEnemy">killEnemy</a></li><li><a href="global.html#loadEnemySkinImage">loadEnemySkinImage</a></li><li><a href="global.html#loop">loop</a></li><li><a href="global.html#moveEnemyInFormation">moveEnemyInFormation</a></li><li><a href="global.html#playBackgroundGameMusic">playBackgroundGameMusic</a></li><li><a href="global.html#playIntroMusic">playIntroMusic</a></li><li><a href="global.html#pressedKeys">pressedKeys</a></li><li><a href="global.html#scheduleEnemyAttacks">scheduleEnemyAttacks</a></li><li><a href="global.html#selectAttackingEnemy">selectAttackingEnemy</a></li><li><a href="global.html#spawnEnemyWave">spawnEnemyWave</a></li><li><a href="global.html#stars">stars</a></li><li><a href="global.html#start">start</a></li><li><a href="global.html#startEnemyAttack">startEnemyAttack</a></li><li><a href="global.html#startNextLevel">startNextLevel</a></li><li><a href="global.html#togglePause">togglePause</a></li><li><a href="global.html#update">update</a></li><li><a href="global.html#updateAttackingEnemy">updateAttackingEnemy</a></li><li><a href="global.html#updateBackground">updateBackground</a></li><li><a href="global.html#updateEnemies">updateEnemies</a></li><li><a href="global.html#updateEnemyShots">updateEnemyShots</a></li><li><a href="global.html#updateInvincibility">updateInvincibility</a></li><li><a href="global.html#updateLevelTransition">updateLevelTransition</a></li><li><a href="global.html#updatePlayer">updatePlayer</a></li><li><a href="global.html#updatePlayerShots">updatePlayerShots</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Wed Dec 10 2025 10:27:16 GMT-0800 (Pacific Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
