<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: systems/enemyAttack.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: systems/enemyAttack.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// js/systems/enemyAttack.js
// Handles enemy dive-attack behavior: selection, path generation, movement, and scheduling.

let canvasRef = null;

/**
 * Stores a reference to the game canvas (used for off-screen exit points).
 *
 * @param {HTMLCanvasElement} canvas
 */
export function initEnemyAttack(canvas) {
  canvasRef = canvas;
}

/**
 * Randomly selects one enemy from those currently in formation that are not already attacking.
 *
 * @param {Array&lt;Object>} enemies - List of all enemy objects.
 * @returns {Object|null} Selected enemy or null if none are available.
 */
export function selectAttackingEnemy(enemies) {
  const availableEnemies = enemies.filter(
    enemy => enemy.state === 'formation' &amp;&amp; !enemy.isAttacking
  );

  if (availableEnemies.length === 0) return null;

  const randomIndex = Math.floor(Math.random() * availableEnemies.length);
  return availableEnemies[randomIndex];
}

/**
 * Initiates a dive attack for a single enemy.
 *
 * @param {Object} enemy  - The enemy that will perform the attack.
 * @param {Object} player - The player object (used to calculate dive point).
 */
export function startEnemyAttack(enemy, player) {
  if (!canvasRef || !player) return;

  enemy.isAttacking = true;
  enemy.state = 'attacking';
  enemy.attackPath = generateAttackPath(enemy, player);
  enemy.attackPathIndex = 0;
  enemy.attackSpeed = 250;
}

/**
 * Generates a five-point attack path:
 *   1. Current position
 *   2. Dive toward player
 *   3. Exit off-screen
 *   4. Return above the formation
 *   5. Back to original formation slot
 *
 * @param {Object} enemy
 * @param {Object} player
 * @returns {Array&lt;{x:number, y:number}>}
 */
function generateAttackPath(enemy, player) {
  if (!canvasRef) return [];

  const startX = enemy.x;
  const startY = enemy.y;

  // Randomised dive point near the player
  const diveX = player.x + (Math.random() - 0.5) * 100;
  const diveY = player.y;

  // Exit direction depends on which side of the screen the enemy started from
  const exitX = startX &lt; canvasRef.width / 2 ? -80 : canvasRef.width + 80;
  const exitY = canvasRef.height + 80;

  // Return above the formation, then final slot
  const returnX = enemy.finalX;
  const returnY = -80;

  return [
    { x: startX, y: startY },
    { x: diveX, y: diveY },
    { x: exitX, y: exitY },
    { x: returnX, y: returnY },
    { x: enemy.finalX, y: enemy.finalY },
  ];
}

/**
 * Moves an attacking enemy along its pre-calculated attack path.
 *
 * @param {Object} enemy - The attacking enemy.
 * @param {number} delta - Time elapsed since last frame (seconds).
 */
export function updateAttackingEnemy(enemy, delta) {
  if (
    !enemy.attackPath ||
    enemy.attackPathIndex >= enemy.attackPath.length - 1
  ) {
    // Attack finished – return to formation
    enemy.isAttacking = false;
    enemy.state = 'formation';
    enemy.x = enemy.finalX;
    enemy.y = enemy.finalY;
    return;
  }

  let remaining = enemy.attackSpeed * delta;

  while (remaining > 0 &amp;&amp; enemy.attackPathIndex &lt; enemy.attackPath.length - 1) {
    const currentTarget = enemy.attackPath[enemy.attackPathIndex + 1];
    const dx = currentTarget.x - enemy.x;
    const dy = currentTarget.y - enemy.y;
    const distance = Math.hypot(dx, dy);

    if (distance &lt;= remaining) {
      enemy.x = currentTarget.x;
      enemy.y = currentTarget.y;
      enemy.attackPathIndex += 1;
      remaining -= distance;
    } else {
      const ratio = remaining / distance;
      enemy.x += dx * ratio;
      enemy.y += dy * ratio;
      remaining = 0;
    }
  }
}

/**
 * Schedules enemy dive attacks on an interval (approximately every 3–5 seconds).
 *
 * @param {Array&lt;Object>} enemies - All enemies.
 * @param {Object} player - Player object.
 * @param {number} delta - Delta time (seconds).
 * @param {Object} attackTimer - Timer object with a `current` property.
 * @returns {Object} Updated timer object.
 */
export function scheduleEnemyAttacks(enemies, player, delta, attackTimer) {
  attackTimer.current -= delta;

  if (attackTimer.current &lt;= 0) {
    const attacker = selectAttackingEnemy(enemies);
    if (attacker) {
      startEnemyAttack(attacker, player);
    }
    attackTimer.current = 3 + Math.random() * 2; // next attack in 3-5 seconds
  }

  return attackTimer;
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="PersistentAudioManager.html">PersistentAudioManager</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Game">Game</a></li><li><a href="global.html#advanceEnemyAlongPath">advanceEnemyAlongPath</a></li><li><a href="global.html#audioManager">audioManager</a></li><li><a href="global.html#barrierY">barrierY</a></li><li><a href="global.html#boxesOverlap">boxesOverlap</a></li><li><a href="global.html#canvas">canvas</a></li><li><a href="global.html#canvasRef">canvasRef</a></li><li><a href="global.html#checkEnemyShotCollisions">checkEnemyShotCollisions</a></li><li><a href="global.html#checkPlayerEnemyCollision">checkPlayerEnemyCollision</a></li><li><a href="global.html#checkPlayerShotCollisions">checkPlayerShotCollisions</a></li><li><a href="global.html#createEnemy">createEnemy</a></li><li><a href="global.html#createInitialGame">createInitialGame</a></li><li><a href="global.html#createPlayer">createPlayer</a></li><li><a href="global.html#createPlayerShot">createPlayerShot</a></li><li><a href="global.html#ctx">ctx</a></li><li><a href="global.html#ctxRef">ctxRef</a></li><li><a href="global.html#draw">draw</a></li><li><a href="global.html#drawBackground">drawBackground</a></li><li><a href="global.html#drawEnemies">drawEnemies</a></li><li><a href="global.html#drawEnemyShots">drawEnemyShots</a></li><li><a href="global.html#drawPlayer">drawPlayer</a></li><li><a href="global.html#drawPlayerShots">drawPlayerShots</a></li><li><a href="global.html#enemyTypes">enemyTypes</a></li><li><a href="global.html#equipSkin">equipSkin</a></li><li><a href="global.html#fireEnemyShot">fireEnemyShot</a></li><li><a href="global.html#formationConfig">formationConfig</a></li><li><a href="global.html#generateAttackPath">generateAttackPath</a></li><li><a href="global.html#generateEntryPath">generateEntryPath</a></li><li><a href="global.html#getActiveSkin">getActiveSkin</a></li><li><a href="global.html#getEnemyHitbox">getEnemyHitbox</a></li><li><a href="global.html#getEnemyShotHitbox">getEnemyShotHitbox</a></li><li><a href="global.html#getEnemySkinImage">getEnemySkinImage</a></li><li><a href="global.html#getOwnedSkins">getOwnedSkins</a></li><li><a href="global.html#getPlayerHitbox">getPlayerHitbox</a></li><li><a href="global.html#getShotHitbox">getShotHitbox</a></li><li><a href="global.html#handleEnemyKilled">handleEnemyKilled</a></li><li><a href="global.html#handleLevelProgression">handleLevelProgression</a></li><li><a href="global.html#handlePlayerHit">handlePlayerHit</a></li><li><a href="global.html#initAudio">initAudio</a></li><li><a href="global.html#initBackground">initBackground</a></li><li><a href="global.html#initEnemyAttack">initEnemyAttack</a></li><li><a href="global.html#initEnemyModule">initEnemyModule</a></li><li><a href="global.html#initInput">initInput</a></li><li><a href="global.html#initPauseMenu">initPauseMenu</a></li><li><a href="global.html#initSharedAudio">initSharedAudio</a></li><li><a href="global.html#initShooting">initShooting</a></li><li><a href="global.html#initialized">initialized</a></li><li><a href="global.html#isGamePaused">isGamePaused</a></li><li><a href="global.html#isKeyPressed">isKeyPressed</a></li><li><a href="global.html#isSkinOwned">isSkinOwned</a></li><li><a href="global.html#killEnemy">killEnemy</a></li><li><a href="global.html#loadEnemySkinImage">loadEnemySkinImage</a></li><li><a href="global.html#loop">loop</a></li><li><a href="global.html#moveEnemyInFormation">moveEnemyInFormation</a></li><li><a href="global.html#playBackgroundGameMusic">playBackgroundGameMusic</a></li><li><a href="global.html#playIntroMusic">playIntroMusic</a></li><li><a href="global.html#pressedKeys">pressedKeys</a></li><li><a href="global.html#scheduleEnemyAttacks">scheduleEnemyAttacks</a></li><li><a href="global.html#selectAttackingEnemy">selectAttackingEnemy</a></li><li><a href="global.html#spawnEnemyWave">spawnEnemyWave</a></li><li><a href="global.html#stars">stars</a></li><li><a href="global.html#start">start</a></li><li><a href="global.html#startEnemyAttack">startEnemyAttack</a></li><li><a href="global.html#startNextLevel">startNextLevel</a></li><li><a href="global.html#togglePause">togglePause</a></li><li><a href="global.html#update">update</a></li><li><a href="global.html#updateAttackingEnemy">updateAttackingEnemy</a></li><li><a href="global.html#updateBackground">updateBackground</a></li><li><a href="global.html#updateEnemies">updateEnemies</a></li><li><a href="global.html#updateEnemyShots">updateEnemyShots</a></li><li><a href="global.html#updateInvincibility">updateInvincibility</a></li><li><a href="global.html#updateLevelTransition">updateLevelTransition</a></li><li><a href="global.html#updatePlayer">updatePlayer</a></li><li><a href="global.html#updatePlayerShots">updatePlayerShots</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Wed Dec 10 2025 10:30:47 GMT-0800 (Pacific Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
